<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hybrid Location Tracker</title>
    <style>
      body { font-family: system-ui, Arial; margin: 16px; color: #111 }
      header { margin-bottom: 12px }
      .card { background: #fff; border: 1px solid #e6e6e6; padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05) }
      label { display:block; margin-top:8px; font-weight:600 }
      input { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #d0d0d0 }
      .btn { display:inline-block; padding:8px 12px; border-radius:8px; background:#111827; color:#fff; text-decoration:none; margin-top:8px; cursor:pointer }
      .muted { color:#6b7280; font-size:13px }
      #geoStatus { margin-top:8px; font-size:13px; color:#374151 }
    </style>
  </head>
  <body>
    <header>
      <h1>Demo Form with Hybrid Location</h1>
    </header>
    <section class="card">
      <h2>Sample Form</h2>
      <form id="demoForm" method="POST" action="/your-backend-endpoint">
        <label for="lat">Latitude</label>
        <input id="lat" name="lat" type="text" placeholder="latitude">

        <label for="lng">Longitude</label>
        <input id="lng" name="lng" type="text" placeholder="longitude">

        <input type="hidden" id="accuracy" name="accuracy">
        <input type="hidden" id="address" name="address">

        <button type="button" class="btn" onclick="getBestLocation()">Get Location</button>
        <button type="submit" class="btn">Submit</button>
      </form>
      <p class="muted">If GPS fails, it will fall back to Google API and then to IP location.</p>
      <div id="geoStatus"></div>
    </section>

    <script>
      const googleApiKey = "YOUR_GOOGLE_API_KEY"; // replace with your API key

      function logStatus(msg) {
        document.getElementById("geoStatus").textContent = msg;
        console.log("[geo]", msg);
      }

      function setCoords(lat, lng, accuracy = 10000, source = "unknown") {
        document.getElementById("lat").value = lat;
        document.getElementById("lng").value = lng;
        document.getElementById("accuracy").value = accuracy;
        logStatus(`Location from ${source} — lat: ${lat}, lng: ${lng} (±${Math.round(accuracy)}m)`);
        getAddressFromLatLng(lat, lng);
      }

      async function getAddressFromLatLng(lat, lng) {
        try {
          const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${googleApiKey}`;
          const res = await fetch(url);
          const data = await res.json();
          if (data.status === "OK" && data.results.length > 0) {
            const address = data.results[0].formatted_address;
            document.getElementById("address").value = address;
            logStatus(`Address: ${address}`);
          }
        } catch (err) {
          console.error("Geocode error:", err);
        }
      }

      function getGpsLocation() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            return reject(new Error("Geolocation not supported"));
          }
          navigator.geolocation.getCurrentPosition(
            pos => {
              resolve({
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                accuracy: pos.coords.accuracy,
                source: "gps"
              });
            },
            err => reject(err),
            { enableHighAccuracy: true, timeout: 8000 }
          );
        });
      }

      async function getGoogleLocation() {
        const url = `https://www.googleapis.com/geolocation/v1/geolocate?key=${googleApiKey}`;
        const res = await fetch(url, { method: "POST" });
        if (!res.ok) throw new Error("Google API error");
        const data = await res.json();
        return {
          lat: data.location.lat,
          lng: data.location.lng,
          accuracy: data.accuracy,
          source: "google"
        };
      }

      async function getIpLocation() {
        const res = await fetch("https://ipapi.co/json/");
        if (!res.ok) throw new Error("IP API error");
        const data = await res.json();
        return {
          lat: data.latitude,
          lng: data.longitude,
          accuracy: 50000,
          source: "ip"
        };
      }

      async function getBestLocation() {
        logStatus("Trying GPS...");
        try {
          const gps = await getGpsLocation();
          setCoords(gps.lat, gps.lng, gps.accuracy, gps.source);
          return;
        } catch (e1) {
          logStatus("GPS failed. Trying Google API...");
          try {
            const g = await getGoogleLocation();
            setCoords(g.lat, g.lng, g.accuracy, g.source);
            return;
          } catch (e2) {
            logStatus("Google API failed. Falling back to IP...");
            try {
              const ip = await getIpLocation();
              setCoords(ip.lat, ip.lng, ip.accuracy, ip.source);
              return;
            } catch (e3) {
              logStatus("All methods failed.");
            }
          }
        }
      }
    </script>
  </body>
</html>
